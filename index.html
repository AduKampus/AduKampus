<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AduKampus - Sistem Pengaduan Kampus</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css"
    rel="stylesheet"
  />
  <link
    href="https://fonts.googleapis.com/css2?family=Inter&display=swap"
    rel="stylesheet"
  />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: "Inter", sans-serif;
    }
    button:focus {
      outline: 2px solid #2563eb;
      outline-offset: 2px;
    }
    /* Scrollbar for sidebar */
    #sidebar::-webkit-scrollbar {
      width: 6px;
    }
    #sidebar::-webkit-scrollbar-thumb {
      background-color: #3b82f6;
      border-radius: 3px;
    }
    /* Modal backdrop */
    #modal-backdrop {
      background-color: rgba(0,0,0,0.5);
    }
    /* Image preview */
    .img-preview {
      max-width: 100%;
      max-height: 150px;
      object-fit: contain;
      border-radius: 0.375rem;
      margin-top: 0.25rem;
    }
    /* PDF link style */
    .pdf-link {
      color: #2563eb;
      text-decoration: underline;
      cursor: pointer;
      font-weight: 600;
    }
  </style>
</head>
<body class="bg-[#e3edff] min-h-screen flex flex-col">
  <!-- Header -->
  <header class="bg-white shadow flex items-center justify-center py-4 sticky top-0 z-30">
    <div class="flex items-center space-x-2">
      <svg
        aria-hidden="true"
        class="h-7 w-7 text-blue-600"
        fill="none"
        focusable="false"
        viewBox="0 0 36 28"
        xmlns="http://www.w3.org/2000/svg"
      >
        <path
          d="M18 0L0 7V21L18 28L36 21V7L18 0Z"
          stroke="#3B82F6"
          stroke-linejoin="round"
          stroke-width="2"
        ></path>
        <path
          d="M18 7L27 11.5L18 16L9 11.5L18 7Z"
          stroke="#3B82F6"
          stroke-linejoin="round"
          stroke-width="2"
        ></path>
        <path
          d="M18 16L27 20.5L18 25L9 20.5L18 16Z"
          stroke="#3B82F6"
          stroke-linejoin="round"
          stroke-width="2"
        ></path>
      </svg>
      <h1 class="font-extrabold text-xl text-black">AduKampus</h1>
    </div>
  </header>

  <div class="flex flex-1 overflow-hidden">
    <!-- Sidebar (only visible after login) -->
    <nav
      id="sidebar"
      class="bg-white w-64 border-r border-gray-200 flex flex-col overflow-y-auto hidden"
      aria-label="Main navigation"
    >
      <ul class="mt-6 space-y-1 px-4">
        <li>
          <button
            id="menu-dashboard"
            class="w-full flex items-center gap-3 px-4 py-3 rounded-md font-semibold text-blue-700 bg-blue-100 hover:bg-blue-200 transition"
            type="button"
          >
            <i class="fas fa-tachometer-alt"></i>
            Dashboard
          </button>
        </li>
        <li>
          <button
            id="menu-kirim"
            class="w-full flex items-center gap-3 px-4 py-3 rounded-md font-semibold text-gray-700 hover:bg-blue-100 transition"
            type="button"
          >
            <i class="fas fa-paper-plane"></i>
            Kirim Pengaduan
          </button>
        </li>
        <li>
          <button
            id="menu-daftar"
            class="w-full flex items-center gap-3 px-4 py-3 rounded-md font-semibold text-gray-700 hover:bg-blue-100 transition"
            type="button"
          >
            <i class="fas fa-list"></i>
            Daftar Pengaduan
          </button>
        </li>
        <li id="menu-user-management-li" class="hidden">
          <button
            id="menu-user-management"
            class="w-full flex items-center gap-3 px-4 py-3 rounded-md font-semibold text-gray-700 hover:bg-blue-100 transition"
            type="button"
          >
            <i class="fas fa-users-cog"></i>
            Kelola User
          </button>
        </li>
        <li id="menu-unit-management-li" class="hidden">
          <button
            id="menu-unit-management"
            class="w-full flex items-center gap-3 px-4 py-3 rounded-md font-semibold text-gray-700 hover:bg-blue-100 transition"
            type="button"
          >
            <i class="fas fa-building"></i>
            Kelola Unit
          </button>
        </li>
        <li>
          <button
            id="menu-logout"
            class="w-full flex items-center gap-3 px-4 py-3 rounded-md font-semibold text-red-600 hover:bg-red-100 transition"
            type="button"
          >
            <i class="fas fa-sign-out-alt"></i>
            Logout
          </button>
        </li>
      </ul>
    </nav>

    <!-- Main content -->
    <main class="flex-1 overflow-y-auto p-6 max-w-7xl mx-auto relative">
      <!-- Login & Register Section -->
      <section id="auth-section" class="max-w-md mx-auto" aria-label="Authentication Section">
        <div class="text-center mb-8">
          <svg
            aria-hidden="true"
            class="mx-auto mb-2"
            fill="none"
            focusable="false"
            height="28"
            viewBox="0 0 36 28"
            width="36"
            xmlns="http://www.w3.org/2000/svg"
          >
            <path
              d="M18 0L0 7V21L18 28L36 21V7L18 0Z"
              stroke="#3B82F6"
              stroke-linejoin="round"
              stroke-width="2"
            ></path>
            <path
              d="M18 7L27 11.5L18 16L9 11.5L18 7Z"
              stroke="#3B82F6"
              stroke-linejoin="round"
              stroke-width="2"
            ></path>
            <path
              d="M18 16L27 20.5L18 25L9 20.5L18 16Z"
              stroke="#3B82F6"
              stroke-linejoin="round"
              stroke-width="2"
            ></path>
          </svg>
          <h1 class="font-extrabold text-xl leading-6 text-black">AduKampus</h1>
          <p class="text-sm text-gray-600 mt-1">
            Sistem Informasi Pengelolaan Pengaduan Kampus
          </p>
        </div>

        <!-- Tabs -->
        <div class="flex justify-center mb-6 space-x-6">
          <button
            id="tab-login"
            class="font-semibold border-b-2 border-blue-600 pb-1 text-blue-700 cursor-pointer"
            type="button"
            aria-selected="true"
            aria-controls="loginForm"
          >
            Login
          </button>
          <button
            id="tab-register"
            class="font-semibold text-gray-500 hover:text-blue-700 cursor-pointer"
            type="button"
            aria-selected="false"
            aria-controls="registerForm"
          >
            Daftar
          </button>
        </div>

        <!-- Login Form -->
        <form
          id="loginForm"
          aria-label="Login AduKampus"
          class="bg-white rounded-lg shadow-md w-full p-6"
          novalidate
        >
          <label class="block text-xs font-bold mb-1" for="login-email">Email</label>
          <input
            class="w-full border border-gray-300 rounded-md px-3 py-2 mb-4 text-sm placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500"
            id="login-email"
            placeholder="nama@example.com"
            required
            type="email"
            autocomplete="username"
          />
          <label class="block text-xs font-bold mb-1" for="login-password">Password</label>
          <div class="relative mb-6">
            <input
              class="w-full border border-gray-300 rounded-md px-3 py-2 pr-10 text-sm placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500"
              id="login-password"
              placeholder="Masukkan password"
              required
              type="password"
              autocomplete="current-password"
            />
            <button
              aria-label="Toggle password visibility"
              class="absolute inset-y-0 right-3 flex items-center text-gray-400 hover:text-gray-600"
              tabindex="-1"
              type="button"
              id="toggleLoginPassword"
            >
              <i class="fas fa-eye"></i>
            </button>
          </div>
          <button
            class="w-full bg-[#0a1128] text-white font-bold py-2 rounded-md mb-6 hover:bg-[#0a1128cc] flex items-center justify-center gap-2"
            type="submit"
          >
            <i class="fas fa-sign-in-alt"></i> Login
          </button>
        </form>

        <!-- Register Form -->
        <form
          id="registerForm"
          aria-label="Daftar AduKampus"
          class="bg-white rounded-lg shadow-md w-full p-6 hidden"
          novalidate
        >
          <label class="block text-xs font-bold mb-1" for="reg-nama">Nama Lengkap</label>
          <input
            class="w-full border border-gray-300 rounded-md px-3 py-2 mb-4 text-sm placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500"
            id="reg-nama"
            placeholder="Nama lengkap"
            required
            type="text"
            autocomplete="name"
          />
          <label class="block text-xs font-bold mb-1" for="reg-email">Email</label>
          <input
            class="w-full border border-gray-300 rounded-md px-3 py-2 mb-4 text-sm placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500"
            id="reg-email"
            placeholder="nama@example.com"
            required
            type="email"
            autocomplete="email"
          />
          <label class="block text-xs font-bold mb-1" for="reg-nim">NIM/NIP</label>
          <input
            class="w-full border border-gray-300 rounded-md px-3 py-2 mb-4 text-sm placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500"
            id="reg-nim"
            placeholder="Nomor Induk Mahasiswa/Dosen"
            required
            type="text"
          />
          <label class="block text-xs font-bold mb-1" for="reg-role">Role</label>
          <select
            id="reg-role"
            class="w-full border border-gray-300 rounded-md px-3 py-2 mb-4 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
            required
          >
            <option value="" disabled selected>Pilih role</option>
            <option value="mahasiswa">Mahasiswa</option>
            <option value="dosen">Dosen</option>
            <option value="admin">Admin</option>
            <option value="superadmin">Super Admin</option>
          </select>
          <label class="block text-xs font-bold mb-1" for="reg-password">Password</label>
          <div class="relative mb-6">
            <input
              class="w-full border border-gray-300 rounded-md px-3 py-2 pr-10 text-sm placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500"
              id="reg-password"
              placeholder="Buat password"
              required
              type="password"
              autocomplete="new-password"
            />
            <button
              aria-label="Toggle password visibility"
              class="absolute inset-y-0 right-3 flex items-center text-gray-400 hover:text-gray-600"
              tabindex="-1"
              type="button"
              id="toggleRegisterPassword"
            >
              <i class="fas fa-eye"></i>
            </button>
          </div>
          <button
            class="w-full bg-[#0a1128] text-white font-bold py-2 rounded-md mb-6 hover:bg-[#0a1128cc] flex items-center justify-center gap-2"
            type="submit"
          >
            <i class="fas fa-user-plus"></i> Daftar
          </button>
        </form>
      </section>

      <!-- Dashboard Section -->
      <section
        id="dashboard-section"
        class="hidden max-w-6xl mx-auto"
        aria-label="Dashboard Pengadu"
      >
        <h2 class="text-2xl font-bold mb-6 text-gray-900">Dashboard</h2>
        <div id="dashboard-content" class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8"></div>
        <div id="dashboard-chart-container" class="hidden bg-white rounded-lg shadow p-6 max-w-md mx-auto md:mx-0 md:max-w-none md:col-span-4">
          <canvas id="adminChart" aria-label="Grafik pie status pengaduan" role="img"></canvas>
        </div>
        <p class="text-center text-gray-500 italic" id="no-complaints-msg">Belum ada data pengaduan.</p>
      </section>

      <!-- Kirim Pengaduan -->
      <section id="kirim-section" class="hidden max-w-xl mx-auto" aria-label="Form Kirim Pengaduan">
        <h2 class="text-2xl font-bold mb-6 text-gray-900 text-center">
          Kirim Pengaduan Baru (Anonimus)
        </h2>
        <form id="complaintForm" class="bg-white rounded-lg shadow p-6 space-y-5" novalidate enctype="multipart/form-data">
          <div>
            <label for="judul" class="block text-sm font-semibold mb-1"
              >Judul Pengaduan</label
            >
            <input
              type="text"
              id="judul"
              name="judul"
              placeholder="Judul pengaduan"
              required
              class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500"
            />
          </div>

          <div>
            <label for="kategori" class="block text-sm font-semibold mb-1"
              >Kategori</label
            >
            <select
              id="kategori"
              name="kategori"
              required
              class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
            >
              <option value="" disabled selected>Pilih kategori</option>
              <option value="Akademik">Akademik</option>
              <option value="Fasilitas">Fasilitas</option>
              <option value="Administrasi">Administrasi</option>
              <option value="Lainnya">Lainnya</option>
            </select>
          </div>

          <div>
            <label for="deskripsi" class="block text-sm font-semibold mb-1"
              >Deskripsi</label
            >
            <textarea
              id="deskripsi"
              name="deskripsi"
              rows="4"
              placeholder="Deskripsikan pengaduan Anda"
              required
              class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 resize-y"
            ></textarea>
          </div>

          <div>
            <label for="unit" class="block text-sm font-semibold mb-1"
              >Unit Terkait</label
            >
            <select
              id="unit"
              name="unit"
              required
              class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
            >
              <option value="" disabled selected>Pilih unit</option>
            </select>
          </div>

          <div>
            <label for="lokasi" class="block text-sm font-semibold mb-1"
              >Lokasi Kejadian</label
            >
            <input
              type="text"
              id="lokasi"
              name="lokasi"
              placeholder="Lokasi kejadian"
              required
              class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500"
            />
          </div>

          <div>
            <label for="prioritas" class="block text-sm font-semibold mb-1"
              >Prioritas</label
            >
            <select
              id="prioritas"
              name="prioritas"
              required
              class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
            >
              <option value="" disabled selected>Pilih prioritas</option>
              <option value="Rendah">Rendah</option>
              <option value="Sedang">Sedang</option>
              <option value="Tinggi">Tinggi</option>
            </select>
          </div>

          <div>
            <label for="telepon" class="block text-sm font-semibold mb-1"
              >Nomor Telepon</label
            >
            <input
              type="tel"
              id="telepon"
              name="telepon"
              placeholder="Nomor telepon"
              required
              class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500"
            />
          </div>

          <div>
            <label for="foto" class="block text-sm font-semibold mb-1">Lampirkan Foto (opsional)</label>
            <input
              type="file"
              id="foto"
              name="foto"
              accept="image/*"
              class="w-full text-sm text-gray-600"
            />
            <img id="foto-preview" alt="Preview foto pengaduan" class="img-preview hidden" />
          </div>

          <fieldset class="border border-gray-300 rounded-md p-4">
            <legend class="text-sm font-semibold text-gray-700 mb-2">
              Informasi Pelapor (Akan disembunyikan dari Admin)
            </legend>
            <div class="space-y-1 text-gray-700 text-sm">
              <p><span class="font-semibold">Nama:</span> <span id="pelapor-nama"></span></p>
              <p><span class="font-semibold">Email:</span> <span id="pelapor-email"></span></p>
              <p><span class="font-semibold">Role:</span> <span id="pelapor-role"></span></p>
              <p><span class="font-semibold">NIM/NIP:</span> <span id="pelapor-nim"></span></p>
            </div>
          </fieldset>

          <button
            type="submit"
            class="w-full bg-[#0a1128] text-white font-bold py-2 rounded-md hover:bg-[#0a1128cc] transition flex items-center justify-center gap-2"
          >
            <i class="fas fa-paper-plane"></i> Kirim Pengaduan
          </button>
        </form>
      </section>

      <!-- Daftar Pengaduan Section -->
      <section id="daftar-section" class="hidden max-w-5xl mx-auto" aria-label="Daftar Pengaduan">
        <h2 class="text-2xl font-bold mb-6 text-gray-900">Daftar Pengaduan</h2>

        <!-- Admin: show only table -->
        <div id="admin-daftar-content" class="hidden bg-white rounded-lg shadow p-6 overflow-x-auto">
          <table class="min-w-full border border-gray-200 text-sm" aria-label="Tabel daftar pengaduan admin">
            <thead class="bg-gray-100">
              <tr>
                <th class="py-3 px-4 border-b border-gray-300 text-left">No</th>
                <th class="py-3 px-4 border-b border-gray-300 text-left">Judul</th>
                <th class="py-3 px-4 border-b border-gray-300 text-left">Kategori</th>
                <th class="py-3 px-4 border-b border-gray-300 text-left">Unit</th>
                <th class="py-3 px-4 border-b border-gray-300 text-left">Tanggal</th>
                <th class="py-3 px-4 border-b border-gray-300 text-left">Status</th>
                <th class="py-3 px-4 border-b border-gray-300 text-left">Prioritas</th>
                <th class="py-3 px-4 border-b border-gray-300 text-left">Surat Keputusan</th>
                <th class="py-3 px-4 border-b border-gray-300 text-left">Aksi</th>
              </tr>
            </thead>
            <tbody id="admin-complaints-tbody"></tbody>
          </table>
        </div>

        <!-- Mahasiswa/Dosen: show complaints list -->
        <div id="user-daftar-content" class="space-y-4"></div>
      </section>

      <!-- User Management Section (Super Admin) -->
      <section id="user-management-section" class="hidden max-w-5xl mx-auto" aria-label="Kelola User">
        <h2 class="text-2xl font-bold mb-6 text-gray-900">Kelola User</h2>
        <div class="mb-4 flex justify-between items-center">
          <button id="btn-add-user" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 flex items-center gap-2">
            <i class="fas fa-user-plus"></i> Tambah User
          </button>
          <input type="text" id="user-search" placeholder="Cari user..." class="border border-gray-300 rounded px-3 py-2 text-sm w-64 focus:outline-none focus:ring-2 focus:ring-blue-500" />
        </div>
        <div class="overflow-x-auto bg-white rounded-lg shadow p-4">
          <table class="min-w-full border border-gray-200 text-sm" aria-label="Tabel kelola user">
            <thead class="bg-gray-100">
              <tr>
                <th class="py-3 px-4 border-b border-gray-300 text-left">No</th>
                <th class="py-3 px-4 border-b border-gray-300 text-left">Nama</th>
                <th class="py-3 px-4 border-b border-gray-300 text-left">Email</th>
                <th class="py-3 px-4 border-b border-gray-300 text-left">Role</th>
                <th class="py-3 px-4 border-b border-gray-300 text-left">NIM/NIP</th>
                <th class="py-3 px-4 border-b border-gray-300 text-left">Aksi</th>
              </tr>
            </thead>
            <tbody id="user-management-tbody"></tbody>
          </table>
        </div>
      </section>

      <!-- Unit Management Section (Super Admin) -->
      <section id="unit-management-section" class="hidden max-w-3xl mx-auto" aria-label="Kelola Unit">
        <h2 class="text-2xl font-bold mb-6 text-gray-900">Kelola Unit</h2>
        <div class="mb-4 flex justify-between items-center">
          <button id="btn-add-unit" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 flex items-center gap-2">
            <i class="fas fa-plus"></i> Tambah Unit
          </button>
          <input type="text" id="unit-search" placeholder="Cari unit..." class="border border-gray-300 rounded px-3 py-2 text-sm w-64 focus:outline-none focus:ring-2 focus:ring-blue-500" />
        </div>
        <div class="overflow-x-auto bg-white rounded-lg shadow p-4">
          <table class="min-w-full border border-gray-200 text-sm" aria-label="Tabel kelola unit">
            <thead class="bg-gray-100">
              <tr>
                <th class="py-3 px-4 border-b border-gray-300 text-left">No</th>
                <th class="py-3 px-4 border-b border-gray-300 text-left">Nama Unit</th>
                <th class="py-3 px-4 border-b border-gray-300 text-left">Aksi</th>
              </tr>
            </thead>
            <tbody id="unit-management-tbody"></tbody>
          </table>
        </div>
      </section>

      <!-- Modal for complaint detail -->
      <div id="modal-backdrop" class="fixed inset-0 hidden items-center justify-center z-50" role="dialog" aria-modal="true" aria-labelledby="modal-title">
        <div class="bg-white rounded-lg shadow-lg max-w-lg w-full p-6 relative overflow-y-auto max-h-[80vh]">
          <h3 id="modal-title" class="text-xl font-bold mb-4">Detail Pengaduan</h3>
          <div id="modal-content" class="space-y-2 text-gray-700 text-sm"></div>
          <button id="modal-close" class="absolute top-3 right-3 text-gray-500 hover:text-gray-700" aria-label="Close modal">
            <i class="fas fa-times fa-lg"></i>
          </button>
        </div>
      </div>

      <!-- Modal for upload Surat Keputusan -->
      <div id="modal-upload-backdrop" class="fixed inset-0 hidden items-center justify-center z-50 bg-black bg-opacity-50">
        <div class="bg-white rounded-lg shadow-lg max-w-md w-full p-6 relative">
          <h3 class="text-xl font-bold mb-4">Lampirkan Surat Keputusan</h3>
          <form id="uploadDecisionForm" class="space-y-4" enctype="multipart/form-data">
            <input type="file" id="decisionFile" accept=".pdf" required class="w-full border border-gray-300 rounded-md px-3 py-2" />
            <div class="flex justify-end gap-3">
              <button type="button" id="uploadCancelBtn" class="px-4 py-2 rounded bg-gray-300 hover:bg-gray-400">Batal</button>
              <button type="submit" class="px-4 py-2 rounded bg-blue-600 text-white hover:bg-blue-700">Upload</button>
            </div>
          </form>
        </div>
      </div>

      <!-- Modal for Add/Edit User -->
      <div id="modal-user-backdrop" class="fixed inset-0 hidden items-center justify-center z-50 bg-black bg-opacity-50">
        <div class="bg-white rounded-lg shadow-lg max-w-md w-full p-6 relative overflow-y-auto max-h-[90vh]">
          <h3 id="modal-user-title" class="text-xl font-bold mb-4">Tambah User</h3>
          <form id="userForm" class="space-y-4" novalidate>
            <div>
              <label for="user-nama" class="block text-sm font-semibold mb-1">Nama Lengkap</label>
              <input type="text" id="user-nama" class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" required />
            </div>
            <div>
              <label for="user-email" class="block text-sm font-semibold mb-1">Email</label>
              <input type="email" id="user-email" class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" required />
            </div>
            <div>
              <label for="user-nim" class="block text-sm font-semibold mb-1">NIM/NIP</label>
              <input type="text" id="user-nim" class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" />
            </div>
            <div>
              <label for="user-role" class="block text-sm font-semibold mb-1">Role</label>
              <select id="user-role" class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                <option value="" disabled selected>Pilih role</option>
                <option value="mahasiswa">Mahasiswa</option>
                <option value="dosen">Dosen</option>
                <option value="admin">Admin</option>
                <option value="superadmin">Super Admin</option>
              </select>
            </div>
            <div>
              <label for="user-password" class="block text-sm font-semibold mb-1">Password</label>
              <div class="relative">
                <input type="password" id="user-password" class="w-full border border-gray-300 rounded-md px-3 py-2 pr-10 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" required />
                <button
                  aria-label="Toggle password visibility"
                  class="absolute inset-y-0 right-3 flex items-center text-gray-400 hover:text-gray-600"
                  tabindex="-1"
                  type="button"
                  id="toggleUserPassword"
                >
                  <i class="fas fa-eye"></i>
                </button>
              </div>
            </div>
            <div class="flex justify-end gap-3">
              <button type="button" id="userCancelBtn" class="px-4 py-2 rounded bg-gray-300 hover:bg-gray-400">Batal</button>
              <button type="submit" class="px-4 py-2 rounded bg-blue-600 text-white hover:bg-blue-700">Simpan</button>
            </div>
          </form>
        </div>
      </div>

      <!-- Modal for Add/Edit Unit -->
      <div id="modal-unit-backdrop" class="fixed inset-0 hidden items-center justify-center z-50 bg-black bg-opacity-50">
        <div class="bg-white rounded-lg shadow-lg max-w-md w-full p-6 relative overflow-y-auto max-h-[90vh]">
          <h3 id="modal-unit-title" class="text-xl font-bold mb-4">Tambah Unit</h3>
          <form id="unitForm" class="space-y-4" novalidate>
            <div>
              <label for="unit-name" class="block text-sm font-semibold mb-1">Nama Unit</label>
              <input type="text" id="unit-name" class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" required />
            </div>
            <div class="flex justify-end gap-3">
              <button type="button" id="unitCancelBtn" class="px-4 py-2 rounded bg-gray-300 hover:bg-gray-400">Batal</button>
              <button type="submit" class="px-4 py-2 rounded bg-blue-600 text-white hover:bg-blue-700">Simpan</button>
            </div>
          </form>
        </div>
      </div>
    </main>
  </div>

  <script>
    // Password toggle for login
    const toggleLoginPasswordBtn = document.getElementById("toggleLoginPassword");
    const loginPasswordInput = document.getElementById("login-password");
    toggleLoginPasswordBtn.addEventListener("click", () => {
      const type = loginPasswordInput.type === "password" ? "text" : "password";
      loginPasswordInput.type = type;
      toggleLoginPasswordBtn.querySelector("i").classList.toggle("fa-eye");
      toggleLoginPasswordBtn.querySelector("i").classList.toggle("fa-eye-slash");
    });

    // Password toggle for register
    const toggleRegisterPasswordBtn = document.getElementById("toggleRegisterPassword");
    const registerPasswordInput = document.getElementById("reg-password");
    toggleRegisterPasswordBtn.addEventListener("click", () => {
      const type = registerPasswordInput.type === "password" ? "text" : "password";
      registerPasswordInput.type = type;
      toggleRegisterPasswordBtn.querySelector("i").classList.toggle("fa-eye");
      toggleRegisterPasswordBtn.querySelector("i").classList.toggle("fa-eye-slash");
    });

    // Password toggle for user modal
    const toggleUserPasswordBtn = document.getElementById("toggleUserPassword");
    const userPasswordInput = document.getElementById("user-password");
    toggleUserPasswordBtn.addEventListener("click", () => {
      const type = userPasswordInput.type === "password" ? "text" : "password";
      userPasswordInput.type = type;
      toggleUserPasswordBtn.querySelector("i").classList.toggle("fa-eye");
      toggleUserPasswordBtn.querySelector("i").classList.toggle("fa-eye-slash");
    });

    // Tabs for login/register
    const tabLogin = document.getElementById("tab-login");
    const tabRegister = document.getElementById("tab-register");
    const loginForm = document.getElementById("loginForm");
    const registerForm = document.getElementById("registerForm");

    tabLogin.addEventListener("click", () => {
      tabLogin.classList.add("border-b-2", "border-blue-600", "pb-1", "text-blue-700");
      tabLogin.setAttribute("aria-selected", "true");
      tabRegister.classList.remove("border-b-2", "border-blue-600", "pb-1", "text-blue-700");
      tabRegister.setAttribute("aria-selected", "false");
      loginForm.classList.remove("hidden");
      registerForm.classList.add("hidden");
    });

    tabRegister.addEventListener("click", () => {
      tabRegister.classList.add("border-b-2", "border-blue-600", "pb-1", "text-blue-700");
      tabRegister.setAttribute("aria-selected", "true");
      tabLogin.classList.remove("border-b-2", "border-blue-600", "pb-1", "text-blue-700");
      tabLogin.setAttribute("aria-selected", "false");
      registerForm.classList.remove("hidden");
      loginForm.classList.add("hidden");
    });

    // Navigation buttons (sidebar)
    const dashboardBtn = document.getElementById("menu-dashboard");
    const kirimBtn = document.getElementById("menu-kirim");
    const daftarBtn = document.getElementById("menu-daftar");
    const logoutBtn = document.getElementById("menu-logout");
    const userManagementBtn = document.getElementById("menu-user-management");
    const unitManagementBtn = document.getElementById("menu-unit-management");

    const userManagementLi = document.getElementById("menu-user-management-li");
    const unitManagementLi = document.getElementById("menu-unit-management-li");

    const sidebar = document.getElementById("sidebar");
    const authSection = document.getElementById("auth-section");
    const dashboardSection = document.getElementById("dashboard-section");
    const kirimSection = document.getElementById("kirim-section");
    const daftarSection = document.getElementById("daftar-section");
    const userManagementSection = document.getElementById("user-management-section");
    const unitManagementSection = document.getElementById("unit-management-section");

    // Admin daftar content containers
    const adminDaftarContent = document.getElementById("admin-daftar-content");
    const userDaftarContent = document.getElementById("user-daftar-content");

    // Dashboard content container and chart container
    const dashboardContent = document.getElementById("dashboard-content");
    const dashboardChartContainer = document.getElementById("dashboard-chart-container");
    const noComplaintsMsg = document.getElementById("no-complaints-msg");

    // Modal elements
    const modalBackdrop = document.getElementById("modal-backdrop");
    const modalContent = document.getElementById("modal-content");
    const modalCloseBtn = document.getElementById("modal-close");

    const modalUploadBackdrop = document.getElementById("modal-upload-backdrop");
    const uploadDecisionForm = document.getElementById("uploadDecisionForm");
    const uploadCancelBtn = document.getElementById("uploadCancelBtn");

    // User Management modal elements
    const modalUserBackdrop = document.getElementById("modal-user-backdrop");
    const modalUserTitle = document.getElementById("modal-user-title");
    const userForm = document.getElementById("userForm");
    const userCancelBtn = document.getElementById("userCancelBtn");
    const userManagementTbody = document.getElementById("user-management-tbody");
    const userSearchInput = document.getElementById("user-search");

    // Unit Management modal elements
    const modalUnitBackdrop = document.getElementById("modal-unit-backdrop");
    const modalUnitTitle = document.getElementById("modal-unit-title");
    const unitForm = document.getElementById("unitForm");
    const unitCancelBtn = document.getElementById("unitCancelBtn");
    const unitManagementTbody = document.getElementById("unit-management-tbody");
    const unitSearchInput = document.getElementById("unit-search");

    // User data storage (in-memory + localStorage)
    // Added superadmin user
    let users = [
      { email: "superadmin@example.com", password: "superadmin123", role: "superadmin", nama: "Super Admin" },
      { email: "admin@example.com", password: "admin123", role: "admin", nama: "Admin" },
      { email: "mahasiswa@example.com", password: "mhs123", role: "mahasiswa", nama: "Mahasiswa", nim: "1234567890" },
      { email: "dosen@example.com", password: "dosen123", role: "dosen", nama: "Dosen", nim: "9876543210" },
    ];

    // Load users from localStorage if exists
    const storedUsers = localStorage.getItem("adukampus_users");
    if (storedUsers) {
      try {
        const parsedUsers = JSON.parse(storedUsers);
        if (Array.isArray(parsedUsers)) {
          users = parsedUsers;
        }
      } catch {}
    }

    // Complaints storage (in-memory + localStorage)
    // Each complaint: {id, pelaporEmail, judul, kategori, deskripsi, unit, lokasi, prioritas, telepon, status, tanggal, fotoDataUrl, suratKeputusanDataUrl}
    let complaints = [];

    // Load complaints from localStorage if exists
    const storedComplaints = localStorage.getItem("adukampus_complaints");
    if (storedComplaints) {
      try {
        const parsedComplaints = JSON.parse(storedComplaints);
        if (Array.isArray(parsedComplaints)) {
          complaints = parsedComplaints;
        }
      } catch {}
    }

    // Units storage (in-memory + localStorage)
    // Each unit: {id, name}
    let units = [
      { id: crypto.randomUUID(), name: "Fakultas Teknik" },
      { id: crypto.randomUUID(), name: "Fakultas Ekonomi" },
      { id: crypto.randomUUID(), name: "Fakultas Hukum" },
      { id: crypto.randomUUID(), name: "Administrasi Umum" }
    ];

    // Load units from localStorage if exists
    const storedUnits = localStorage.getItem("adukampus_units");
    if (storedUnits) {
      try {
        const parsedUnits = JSON.parse(storedUnits);
        if (Array.isArray(parsedUnits)) {
          units = parsedUnits;
        }
      } catch {}
    }

    // User state
    let loggedIn = false;
    let currentUser = null;
    let currentComplaintForDecision = null;

    // Chart instance
    let adminChartInstance = null;

    // Show/hide sections and sidebar based on role and menu
    function setActiveMenu(activeBtn) {
      [dashboardBtn, kirimBtn, daftarBtn, userManagementBtn, unitManagementBtn].forEach((btn) => {
        if (!btn) return;
        if (btn === activeBtn) {
          btn.classList.add("text-blue-700", "bg-blue-100");
          btn.classList.remove("text-gray-700");
        } else {
          btn.classList.remove("text-blue-700", "bg-blue-100");
          btn.classList.add("text-gray-700");
        }
      });
    }

    function showSection(section) {
      [dashboardSection, kirimSection, daftarSection, authSection, userManagementSection, unitManagementSection].forEach((sec) => {
        sec.classList.add("hidden");
      });
      section.classList.remove("hidden");
    }

    function showSidebar(show) {
      if (show) {
        sidebar.classList.remove("hidden");
      } else {
        sidebar.classList.add("hidden");
      }
    }

    function showMenuForRole(role) {
      if (role === "mahasiswa" || role === "dosen") {
        showSidebar(true);
        dashboardBtn.parentElement.style.display = "block";
        kirimBtn.parentElement.style.display = "block";
        daftarBtn.parentElement.style.display = "block";
        userManagementLi.style.display = "none";
        unitManagementLi.style.display = "none";
        logoutBtn.parentElement.style.display = "block";
      } else if (role === "admin") {
        showSidebar(true);
        dashboardBtn.parentElement.style.display = "block";
        kirimBtn.parentElement.style.display = "none";
        daftarBtn.parentElement.style.display = "block";
        userManagementLi.style.display = "none";
        unitManagementLi.style.display = "none";
        logoutBtn.parentElement.style.display = "block";
      } else if (role === "superadmin") {
        showSidebar(true);
        dashboardBtn.parentElement.style.display = "block";
        kirimBtn.parentElement.style.display = "none";
        daftarBtn.parentElement.style.display = "block";
        userManagementLi.style.display = "block";
        unitManagementLi.style.display = "block";
        logoutBtn.parentElement.style.display = "block";
      } else {
        // Not logged in
        showSidebar(false);
        dashboardBtn.parentElement.style.display = "none";
        kirimBtn.parentElement.style.display = "none";
        daftarBtn.parentElement.style.display = "none";
        userManagementLi.style.display = "none";
        unitManagementLi.style.display = "none";
        logoutBtn.parentElement.style.display = "none";
      }
    }

    // Save users to localStorage
    function saveUsers() {
      localStorage.setItem("adukampus_users", JSON.stringify(users));
    }

    // Save complaints to localStorage
    function saveComplaints() {
      localStorage.setItem("adukampus_complaints", JSON.stringify(complaints));
    }

    // Save units to localStorage
    function saveUnits() {
      localStorage.setItem("adukampus_units", JSON.stringify(units));
    }

    // Update dashboard stats for mahasiswa/dosen and admin
    function updateDashboardStats() {
      if (!currentUser) return;
      if (currentUser.role !== "admin" && currentUser.role !== "superadmin") {
        // Mahasiswa/Dosen dashboard stats: own complaints
        const userComplaints = complaints.filter(c => c.pelaporEmail === currentUser.email);
        const total = userComplaints.length;
        const done = userComplaints.filter(c => c.status === "Selesai").length;
        const processing = userComplaints.filter(c => c.status === "Diproses").length;
        const pending = userComplaints.filter(c => c.status === "Menunggu").length;

        dashboardContent.innerHTML = `
          <div class="bg-white rounded-lg shadow p-5 flex items-center gap-4 hover:shadow-lg transition cursor-default">
            <div class="bg-blue-500 text-white rounded-full p-3 flex items-center justify-center">
              <i class="fas fa-inbox fa-lg"></i>
            </div>
            <div>
              <p class="text-sm font-semibold text-gray-500">Total Pengaduan</p>
              <p class="text-2xl font-extrabold text-blue-700">${total}</p>
            </div>
          </div>
          <div class="bg-white rounded-lg shadow p-5 flex items-center gap-4 hover:shadow-lg transition cursor-default">
            <div class="bg-green-500 text-white rounded-full p-3 flex items-center justify-center">
              <i class="fas fa-check-circle fa-lg"></i>
            </div>
            <div>
              <p class="text-sm font-semibold text-gray-500">Selesai</p>
              <p class="text-2xl font-extrabold text-green-700">${done}</p>
            </div>
          </div>
          <div class="bg-white rounded-lg shadow p-5 flex items-center gap-4 hover:shadow-lg transition cursor-default">
            <div class="bg-yellow-400 text-white rounded-full p-3 flex items-center justify-center">
              <i class="fas fa-spinner fa-lg"></i>
            </div>
            <div>
              <p class="text-sm font-semibold text-gray-500">Diproses</p>
              <p class="text-2xl font-extrabold text-yellow-600">${processing}</p>
            </div>
          </div>
          <div class="bg-white rounded-lg shadow p-5 flex items-center gap-4 hover:shadow-lg transition cursor-default">
            <div class="bg-red-500 text-white rounded-full p-3 flex items-center justify-center">
              <i class="fas fa-clock fa-lg"></i>
            </div>
            <div>
              <p class="text-sm font-semibold text-gray-500">Menunggu</p>
              <p class="text-2xl font-extrabold text-red-700">${pending}</p>
            </div>
          </div>
        `;
        dashboardChartContainer.classList.add("hidden");

        if (total === 0) {
          noComplaintsMsg.classList.remove("hidden");
        } else {
          noComplaintsMsg.classList.add("hidden");
        }
      } else {
        // Admin and Superadmin dashboard stats: all complaints + pie chart
        const total = complaints.length;
        const done = complaints.filter(c => c.status === "Selesai").length;
        const processing = complaints.filter(c => c.status === "Diproses").length;
        const pending = complaints.filter(c => c.status === "Menunggu").length;

        dashboardContent.innerHTML = `
          <div class="bg-white rounded-lg shadow p-5 flex items-center gap-4 cursor-default">
            <div class="bg-blue-500 text-white rounded-full p-3 flex items-center justify-center">
              <i class="fas fa-inbox fa-lg"></i>
            </div>
            <div>
              <p class="text-sm font-semibold text-gray-500">Total Pengaduan</p>
              <p class="text-2xl font-extrabold text-blue-700">${total}</p>
            </div>
          </div>
          <div class="bg-white rounded-lg shadow p-5 flex items-center gap-4 cursor-default">
            <div class="bg-green-500 text-white rounded-full p-3 flex items-center justify-center">
              <i class="fas fa-check-circle fa-lg"></i>
            </div>
            <div>
              <p class="text-sm font-semibold text-gray-500">Selesai</p>
              <p class="text-2xl font-extrabold text-green-700">${done}</p>
            </div>
          </div>
          <div class="bg-white rounded-lg shadow p-5 flex items-center gap-4 cursor-default">
            <div class="bg-yellow-400 text-white rounded-full p-3 flex items-center justify-center">
              <i class="fas fa-spinner fa-lg"></i>
            </div>
            <div>
              <p class="text-sm font-semibold text-gray-500">Diproses</p>
              <p class="text-2xl font-extrabold text-yellow-600">${processing}</p>
            </div>
          </div>
          <div class="bg-white rounded-lg shadow p-5 flex items-center gap-4 cursor-default">
            <div class="bg-red-500 text-white rounded-full p-3 flex items-center justify-center">
              <i class="fas fa-clock fa-lg"></i>
            </div>
            <div>
              <p class="text-sm font-semibold text-gray-500">Menunggu</p>
              <p class="text-2xl font-extrabold text-red-700">${pending}</p>
            </div>
          </div>
        `;
        dashboardChartContainer.classList.remove("hidden");

        if (total === 0) {
          noComplaintsMsg.classList.remove("hidden");
          dashboardChartContainer.classList.add("hidden");
        } else {
          noComplaintsMsg.classList.add("hidden");
          renderAdminChart();
        }
      }
    }

    // Render daftar pengaduan for mahasiswa/dosen with detail button
    function renderDaftarPengaduan() {
      if (!currentUser) return;
      if (currentUser.role === "admin" || currentUser.role === "superadmin") {
        // Show admin daftar content, hide user daftar content
        adminDaftarContent.classList.remove("hidden");
        userDaftarContent.classList.add("hidden");
        renderAdminComplaints();
      } else {
        // Show user daftar content, hide admin daftar content
        adminDaftarContent.classList.add("hidden");
        userDaftarContent.classList.remove("hidden");
        const container = userDaftarContent;
        container.innerHTML = "";
        const userComplaints = complaints.filter(c => c.pelaporEmail === currentUser.email);
        if (userComplaints.length === 0) {
          container.innerHTML = '<p class="text-center text-gray-500 italic">Belum ada pengaduan yang dikirim.</p>';
          return;
        }
        userComplaints.forEach(c => {
          const card = document.createElement("article");
          card.className = "bg-white rounded-lg shadow p-5 hover:shadow-lg transition cursor-pointer focus:outline-none focus:ring-2 focus:ring-blue-500";
          card.tabIndex = 0;
          card.setAttribute("role", "button");
          card.setAttribute("aria-label", `Lihat detail pengaduan: ${c.judul}`);

          const statusColors = {
            "Selesai": "bg-green-500 text-green-100",
            "Diproses": "bg-yellow-400 text-yellow-900",
            "Menunggu": "bg-red-500 text-red-100"
          };
          const statusClass = statusColors[c.status] || "bg-gray-300 text-gray-700";

          let fotoHtml = "";
          if (c.fotoDataUrl) {
            fotoHtml = `<img src="${c.fotoDataUrl}" alt="Foto lampiran pengaduan" class="mt-2 rounded max-h-40 object-contain border border-gray-300" />`;
          }

          // Surat Keputusan display: show link if exists, else "Belum ada keputusan"
          let suratHtml = "";
          if (c.suratKeputusanDataUrl) {
            suratHtml = `<p class="mt-2"><strong>Surat Keputusan:</strong> <a href="${c.suratKeputusanDataUrl}" target="_blank" rel="noopener" class="pdf-link">Lihat Surat Keputusan (PDF)</a></p>`;
          } else {
            suratHtml = `<p class="mt-2"><strong>Surat Keputusan:</strong> Belum ada keputusan</p>`;
          }

          card.innerHTML = `
            <div class="flex justify-between items-center mb-2">
              <h3 class="font-semibold text-lg text-gray-900">${c.judul}</h3>
              <span class="text-xs font-bold px-2 py-1 rounded-full ${statusClass}">${c.status}</span>
            </div>
            <p class="text-sm text-gray-600 mb-1"><span class="font-semibold">Prioritas:</span> ${c.prioritas}</p>
            <p class="text-sm text-gray-600 mb-1"><span class="font-semibold">Kategori:</span> ${c.kategori}</p>
            <p class="text-sm text-gray-600 mb-1"><span class="font-semibold">Unit:</span> ${c.unit}</p>
            <p class="text-xs text-gray-400">${new Date(c.tanggal).toLocaleDateString()}</p>
            ${fotoHtml}
            ${suratHtml}
            <button class="mt-3 text-blue-600 font-semibold hover:underline focus:outline-none" type="button">Lihat Detail</button>
          `;
          container.appendChild(card);

          // Detail button event
          const detailBtn = card.querySelector("button:last-of-type");
          detailBtn.addEventListener("click", () => {
            openModal(c);
          });
          // Also open modal on card keyboard enter or space
          card.addEventListener("keydown", (e) => {
            if (e.key === "Enter" || e.key === " ") {
              e.preventDefault();
              openModal(c);
            }
          });
        });
      }
    }

    // Modal open/close functions
    function openModal(complaint) {
      let fotoHtml = "";
      if (complaint.fotoDataUrl) {
        fotoHtml = `<p><strong>Foto Lampiran:</strong><br/><img src="${complaint.fotoDataUrl}" alt="Foto lampiran pengaduan" class="max-w-full rounded mt-1" /></p>`;
      }
      let suratHtml = "";
      if (complaint.suratKeputusanDataUrl) {
        suratHtml = `<p><strong>Surat Keputusan:</strong> <a href="${complaint.suratKeputusanDataUrl}" target="_blank" rel="noopener" class="pdf-link">Lihat Surat Keputusan (PDF)</a></p>`;
      } else {
        suratHtml = `<p><strong>Surat Keputusan:</strong> Belum ada keputusan</p>`;
      }
      modalContent.innerHTML = `
        <p><strong>Judul:</strong> ${complaint.judul}</p>
        <p><strong>Kategori:</strong> ${complaint.kategori}</p>
        <p><strong>Deskripsi:</strong> ${complaint.deskripsi}</p>
        <p><strong>Unit Terkait:</strong> ${complaint.unit}</p>
        <p><strong>Lokasi Kejadian:</strong> ${complaint.lokasi}</p>
        <p><strong>Prioritas:</strong> ${complaint.prioritas}</p>
        <p><strong>Nomor Telepon:</strong> ${complaint.telepon}</p>
        ${fotoHtml}
        <p><strong>Status:</strong> ${complaint.status}</p>
        <p><strong>Tanggal:</strong> ${new Date(complaint.tanggal).toLocaleString()}</p>
        ${suratHtml}
      `;
      modalBackdrop.classList.remove("hidden");
      modalBackdrop.classList.add("flex");
      modalCloseBtn.focus();
    }
    function closeModal() {
      modalBackdrop.classList.add("hidden");
      modalBackdrop.classList.remove("flex");
    }
    modalCloseBtn.addEventListener("click", closeModal);
    modalBackdrop.addEventListener("click", (e) => {
      if (e.target === modalBackdrop) closeModal();
    });
    document.addEventListener("keydown", (e) => {
      if (e.key === "Escape" && !modalBackdrop.classList.contains("hidden")) {
        closeModal();
      }
    });

    // Image preview for complaint photo
    const fotoInput = document.getElementById("foto");
    const fotoPreview = document.getElementById("foto-preview");
    fotoInput.addEventListener("change", () => {
      const file = fotoInput.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = e => {
          fotoPreview.src = e.target.result;
          fotoPreview.classList.remove("hidden");
        };
        reader.readAsDataURL(file);
      } else {
        fotoPreview.src = "";
        fotoPreview.classList.add("hidden");
      }
    });

    // Chart rendering for admin dashboard (Pie chart of status distribution)
    function renderAdminChart() {
      const ctx = document.getElementById('adminChart').getContext('2d');

      const statusCounts = {
        "Menunggu": 0,
        "Diproses": 0,
        "Selesai": 0
      };

      complaints.forEach(c => {
        if (statusCounts.hasOwnProperty(c.status)) {
          statusCounts[c.status]++;
        }
      });

      const data = {
        labels: ["Menunggu", "Diproses", "Selesai"],
        datasets: [{
          data: [statusCounts["Menunggu"], statusCounts["Diproses"], statusCounts["Selesai"]],
          backgroundColor: ['#ef4444', '#fbbf24', '#22c55e'],
          hoverOffset: 30,
          borderRadius: 6,
          borderWidth: 1,
          borderColor: '#fff',
        }]
      };

      if (adminChartInstance) {
        adminChartInstance.destroy();
      }

      adminChartInstance = new Chart(ctx, {
        type: 'pie',
        data: data,
        options: {
          responsive: true,
          plugins: {
            legend: {
              position: 'bottom',
              labels: {
                font: {
                  size: 14
                }
              }
            },
            tooltip: {
              enabled: true,
              callbacks: {
                label: function(context) {
                  const label = context.label || '';
                  const value = context.parsed || 0;
                  return `${label}: ${value}`;
                }
              }
            }
          }
        }
      });
    }

    // Render admin complaints table with detail modal, status change, and upload decision
    function renderAdminComplaints() {
      const tbody = document.getElementById("admin-complaints-tbody");
      tbody.innerHTML = "";
      if (complaints.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="9" class="text-center py-6 text-gray-500 italic">
              Belum ada data pengaduan.
            </td>
          </tr>
        `;
        return;
      }
      complaints.forEach((c, idx) => {
        const tr = document.createElement("tr");
        const statusColors = {
          "Selesai": "bg-green-500 text-green-100",
          "Diproses": "bg-yellow-400 text-yellow-900",
          "Menunggu": "bg-red-500 text-red-100"
        };
        const statusClass = statusColors[c.status] || "bg-gray-300 text-gray-700";

        let suratLink = c.suratKeputusanDataUrl
          ? `<a href="${c.suratKeputusanDataUrl}" target="_blank" rel="noopener" class="pdf-link">Lihat Surat</a>`
          : `<button data-id="${c.id}" class="btn-upload-decision px-2 py-1 bg-green-600 text-white rounded hover:bg-green-700 text-xs">Upload Surat</button>`;

        tr.innerHTML = `
          <td class="py-3 px-4 border-b border-gray-200">${idx + 1}</td>
          <td class="py-3 px-4 border-b border-gray-200">${c.judul}</td>
          <td class="py-3 px-4 border-b border-gray-200">${c.kategori}</td>
          <td class="py-3 px-4 border-b border-gray-200">${c.unit}</td>
          <td class="py-3 px-4 border-b border-gray-200">${new Date(c.tanggal).toLocaleDateString()}</td>
          <td class="py-3 px-4 border-b border-gray-200">
            <span class="px-2 py-1 rounded-full ${statusClass}">${c.status}</span>
          </td>
          <td class="py-3 px-4 border-b border-gray-200">${c.prioritas}</td>
          <td class="py-3 px-4 border-b border-gray-200">${suratLink}</td>
          <td class="py-3 px-4 border-b border-gray-200 flex gap-2 items-center">
            <button data-id="${c.id}" class="btn-detail px-2 py-1 bg-blue-600 text-white rounded hover:bg-blue-700 text-xs">Detail</button>
            <select aria-label="Ubah status pengaduan" data-id="${c.id}" class="border border-gray-300 rounded px-2 py-1 text-sm">
              <option value="Menunggu" ${c.status === "Menunggu" ? "selected" : ""}>Menunggu</option>
              <option value="Diproses" ${c.status === "Diproses" ? "selected" : ""}>Diproses</option>
              <option value="Selesai" ${c.status === "Selesai" ? "selected" : ""}>Selesai</option>
            </select>
          </td>
        `;
        tbody.appendChild(tr);
      });

      // Add event listeners to detail buttons
      tbody.querySelectorAll(".btn-detail").forEach(btn => {
        btn.addEventListener("click", (e) => {
          const id = e.target.getAttribute("data-id");
          const complaint = complaints.find(c => c.id === id);
          if (complaint) openModal(complaint);
        });
      });

      // Add event listeners to selects
      tbody.querySelectorAll("select").forEach(select => {
        select.addEventListener("change", (e) => {
          const id = e.target.getAttribute("data-id");
          const newStatus = e.target.value;
          const complaint = complaints.find(c => c.id === id);
          if (complaint) {
            complaint.status = newStatus;
            saveComplaints();
            alert(`Status pengaduan "${complaint.judul}" diubah menjadi ${newStatus}.`);
            updateDashboardStats();
            renderDaftarPengaduan();
          }
        });
      });

      // Add event listeners to upload decision buttons
      tbody.querySelectorAll(".btn-upload-decision").forEach(btn => {
        btn.addEventListener("click", (e) => {
          const id = e.target.getAttribute("data-id");
          currentComplaintForDecision = complaints.find(c => c.id === id);
          if (currentComplaintForDecision) {
            modalUploadBackdrop.classList.remove("hidden");
            modalUploadBackdrop.classList.add("flex");
          }
        });
      });
    }

    // Update pelapor info in complaint form
    function updatePelaporInfo() {
      if (!currentUser) return;
      document.getElementById("pelapor-nama").textContent = currentUser.nama || "";
      document.getElementById("pelapor-email").textContent = currentUser.email || "";
      document.getElementById("pelapor-role").textContent = currentUser.role === "mahasiswa" ? "Mahasiswa" : currentUser.role === "dosen" ? "Dosen" : currentUser.role;
      document.getElementById("pelapor-nim").textContent = currentUser.nim || "";
    }

    // Populate unit select in complaint form
    function populateUnitSelect() {
      const unitSelect = document.getElementById("unit");
      unitSelect.innerHTML = '<option value="" disabled selected>Pilih unit</option>';
      units.forEach(u => {
        const option = document.createElement("option");
        option.value = u.name;
        option.textContent = u.name;
        unitSelect.appendChild(option);
      });
    }

    // Initialize view
    function initialize() {
      showMenuForRole(null);
      showSection(authSection);
      populateUnitSelect();
    }

    // Event listeners for menu buttons
    dashboardBtn.addEventListener("click", () => {
      setActiveMenu(dashboardBtn);
      showSection(dashboardSection);
      updateDashboardStats();
    });
    kirimBtn.addEventListener("click", () => {
      setActiveMenu(kirimBtn);
      showSection(kirimSection);
      updatePelaporInfo();
      populateUnitSelect();
    });
    daftarBtn.addEventListener("click", () => {
      setActiveMenu(daftarBtn);
      showSection(daftarSection);
      renderDaftarPengaduan();
    });
    logoutBtn.addEventListener("click", () => {
      loggedIn = false;
      currentUser = null;
      showMenuForRole(null);
      showSection(authSection);
      alert("Anda telah logout.");
    });
    userManagementBtn.addEventListener("click", () => {
      setActiveMenu(userManagementBtn);
      showSection(userManagementSection);
      renderUserManagementTable();
    });
    unitManagementBtn.addEventListener("click", () => {
      setActiveMenu(unitManagementBtn);
      showSection(unitManagementSection);
      renderUnitManagementTable();
    });

    // Login form handling
    loginForm.addEventListener("submit", (e) => {
      e.preventDefault();
      const email = loginForm.querySelector("#login-email").value.trim().toLowerCase();
      const password = loginForm.querySelector("#login-password").value.trim();

      const user = users.find(u => u.email === email && u.password === password);
      if (user) {
        loggedIn = true;
        currentUser = user;
        alert(`Login berhasil sebagai ${user.role === "superadmin" ? "Super Admin" : user.role === "admin" ? "Admin" : user.role === "mahasiswa" ? "Mahasiswa" : "Dosen"}.`);
        showMenuForRole(user.role);
        setActiveMenu(dashboardBtn);
        showSection(dashboardSection);
        updateDashboardStats();
      } else {
        alert("Email atau password salah.");
      }
      loginForm.reset();
    });

    // Register form handling
    registerForm.addEventListener("submit", (e) => {
      e.preventDefault();
      const nama = registerForm.querySelector("#reg-nama").value.trim();
      const email = registerForm.querySelector("#reg-email").value.trim().toLowerCase();
      const nim = registerForm.querySelector("#reg-nim").value.trim();
      const role = registerForm.querySelector("#reg-role").value;
      const password = registerForm.querySelector("#reg-password").value.trim();

      if (!nama || !email || !nim || !password || !role) {
        alert("Semua field harus diisi.");
        return;
      }
      if (users.some(u => u.email === email)) {
        alert("Email sudah terdaftar, silakan login.");
        return;
      }
      users.push({ email, password, role, nama, nim });
      saveUsers();
      alert("Pendaftaran berhasil! Silakan login.");
      tabLogin.click();
      registerForm.reset();
    });

    // Complaint form submission (anonymous)
    const complaintForm = document.getElementById("complaintForm");
    complaintForm.addEventListener("submit", (e) => {
      e.preventDefault();
      if (!loggedIn || !currentUser || (currentUser.role !== "mahasiswa" && currentUser.role !== "dosen")) {
        alert("Anda harus login sebagai mahasiswa atau dosen untuk mengirim pengaduan.");
        return;
      }
      const fotoFile = fotoInput.files[0];
      if (fotoFile && !fotoFile.type.startsWith("image/")) {
        alert("File lampiran harus berupa gambar.");
        return;
      }

      const reader = new FileReader();
      reader.onload = function(event) {
        const fotoDataUrl = event.target.result || null;

        const formData = {
          id: crypto.randomUUID(),
          pelaporEmail: currentUser.email,
          judul: complaintForm.judul.value.trim(),
          kategori: complaintForm.kategori.value,
          deskripsi: complaintForm.deskripsi.value.trim(),
          unit: complaintForm.unit.value,
          lokasi: complaintForm.lokasi.value.trim(),
          prioritas: complaintForm.prioritas.value,
          telepon: complaintForm.telepon.value.trim(),
          status: "Menunggu",
          tanggal: new Date().toISOString(),
          fotoDataUrl: fotoDataUrl,
          suratKeputusanDataUrl: null,
        };

        complaints.push(formData);
        saveComplaints();

        alert(
          "Pengaduan berhasil dikirim secara anonimus.\n\n" +
            "Judul: " +
            formData.judul +
            "\nKategori: " +
            formData.kategori +
            "\nUnit: " +
            formData.unit
        );
        complaintForm.reset();
        fotoPreview.src = "";
        fotoPreview.classList.add("hidden");
        setActiveMenu(daftarBtn);
        showSection(daftarSection);
        renderDaftarPengaduan();
        updateDashboardStats();
      };

      if (fotoFile) {
        reader.readAsDataURL(fotoFile);
      } else {
        reader.onload({ target: { result: null } });
      }
    });

    // Upload Surat Keputusan modal handlers
    uploadCancelBtn.addEventListener("click", () => {
      modalUploadBackdrop.classList.add("hidden");
      modalUploadBackdrop.classList.remove("flex");
      uploadDecisionForm.reset();
    });

    uploadDecisionForm.addEventListener("submit", (e) => {
      e.preventDefault();
      const fileInput = document.getElementById("decisionFile");
      const file = fileInput.files[0];
      if (!file) {
        alert("Silakan pilih file PDF.");
        return;
      }
      if (file.type !== "application/pdf") {
        alert("File harus berupa PDF.");
        return;
      }
      const reader = new FileReader();
      reader.onload = function(event) {
        if (currentComplaintForDecision) {
          currentComplaintForDecision.suratKeputusanDataUrl = event.target.result;
          saveComplaints();
          alert("Surat Keputusan berhasil dilampirkan.");
          modalUploadBackdrop.classList.add("hidden");
          modalUploadBackdrop.classList.remove("flex");
          uploadDecisionForm.reset();
          if (currentUser && (currentUser.role === "admin" || currentUser.role === "superadmin")) {
            renderDaftarPengaduan();
          }
        }
      };
      reader.readAsDataURL(file);
    });

    // User Management Functions
    let editingUserId = null;

    function renderUserManagementTable(filter = "") {
      userManagementTbody.innerHTML = "";
      let filteredUsers = users;
      if (filter.trim() !== "") {
        const f = filter.toLowerCase();
        filteredUsers = users.filter(u =>
          u.nama.toLowerCase().includes(f) ||
          u.email.toLowerCase().includes(f) ||
          (u.nim && u.nim.toLowerCase().includes(f)) ||
          u.role.toLowerCase().includes(f)
        );
      }
      if (filteredUsers.length === 0) {
        userManagementTbody.innerHTML = `
          <tr>
            <td colspan="6" class="text-center py-6 text-gray-500 italic">Tidak ada user ditemukan.</td>
          </tr>
        `;
        return;
      }
      filteredUsers.forEach((u, idx) => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td class="py-3 px-4 border-b border-gray-200">${idx + 1}</td>
          <td class="py-3 px-4 border-b border-gray-200">${u.nama}</td>
          <td class="py-3 px-4 border-b border-gray-200">${u.email}</td>
          <td class="py-3 px-4 border-b border-gray-200 capitalize">${u.role}</td>
          <td class="py-3 px-4 border-b border-gray-200">${u.nim || ""}</td>
          <td class="py-3 px-4 border-b border-gray-200 flex gap-2">
            <button data-email="${u.email}" class="btn-edit-user px-2 py-1 bg-yellow-500 text-white rounded hover:bg-yellow-600 text-xs flex items-center gap-1"><i class="fas fa-edit"></i> Edit</button>
            <button data-email="${u.email}" class="btn-delete-user px-2 py-1 bg-red-600 text-white rounded hover:bg-red-700 text-xs flex items-center gap-1"><i class="fas fa-trash-alt"></i> Hapus</button>
          </td>
        `;
        userManagementTbody.appendChild(tr);
      });

      // Edit buttons
      userManagementTbody.querySelectorAll(".btn-edit-user").forEach(btn => {
        btn.addEventListener("click", (e) => {
          const email = e.currentTarget.getAttribute("data-email");
          openUserModalForEdit(email);
        });
      });

      // Delete buttons
      userManagementTbody.querySelectorAll(".btn-delete-user").forEach(btn => {
        btn.addEventListener("click", (e) => {
          const email = e.currentTarget.getAttribute("data-email");
          if (email === currentUser.email) {
            alert("Anda tidak dapat menghapus user yang sedang login.");
            return;
          }
          if (confirm("Apakah Anda yakin ingin menghapus user ini?")) {
            users = users.filter(u => u.email !== email);
            saveUsers();
            renderUserManagementTable(userSearchInput.value);
            alert("User berhasil dihapus.");
          }
        });
      });
    }

    function openUserModalForAdd() {
      editingUserId = null;
      modalUserTitle.textContent = "Tambah User";
      userForm.reset();
      modalUserBackdrop.classList.remove("hidden");
      modalUserBackdrop.classList.add("flex");
      userPasswordInput.required = true;
      userPasswordInput.type = "password";
      toggleUserPasswordBtn.querySelector("i").classList.add("fa-eye");
      toggleUserPasswordBtn.querySelector("i").classList.remove("fa-eye-slash");
      userForm.querySelector("#user-email").disabled = false;
      userForm.querySelector("#user-nama").focus();
    }

    function openUserModalForEdit(email) {
      const user = users.find(u => u.email === email);
      if (!user) return;
      editingUserId = email;
      modalUserTitle.textContent = "Edit User";
      userForm.reset();
      userForm.querySelector("#user-nama").value = user.nama || "";
      userForm.querySelector("#user-email").value = user.email || "";
      userForm.querySelector("#user-nim").value = user.nim || "";
      userForm.querySelector("#user-role").value = user.role || "";
      userForm.querySelector("#user-password").value = "";
      userPasswordInput.required = false;
      userForm.querySelector("#user-email").disabled = true;
      modalUserBackdrop.classList.remove("hidden");
      modalUserBackdrop.classList.add("flex");
      userForm.querySelector("#user-nama").focus();
      userPasswordInput.type = "password";
      toggleUserPasswordBtn.querySelector("i").classList.add("fa-eye");
      toggleUserPasswordBtn.querySelector("i").classList.remove("fa-eye-slash");
    }

    userForm.addEventListener("submit", (e) => {
      e.preventDefault();
      const nama = userForm.querySelector("#user-nama").value.trim();
      const email = userForm.querySelector("#user-email").value.trim().toLowerCase();
      const nim = userForm.querySelector("#user-nim").value.trim();
      const role = userForm.querySelector("#user-role").value;
      const password = userForm.querySelector("#user-password").value.trim();

      if (!nama || !email || !role) {
        alert("Nama, Email, dan Role harus diisi.");
        return;
      }

      if (editingUserId) {
        // Edit mode
        const userIndex = users.findIndex(u => u.email === editingUserId);
        if (userIndex === -1) {
          alert("User tidak ditemukan.");
          return;
        }
        users[userIndex].nama = nama;
        users[userIndex].nim = nim;
        users[userIndex].role = role;
        if (password) {
          users[userIndex].password = password;
        }
        saveUsers();
        alert("User berhasil diperbarui.");
      } else {
        // Add mode
        if (users.some(u => u.email === email)) {
          alert("Email sudah terdaftar.");
          return;
        }
        if (!password) {
          alert("Password harus diisi.");
          return;
        }
        users.push({ email, password, role, nama, nim });
        saveUsers();
        alert("User berhasil ditambahkan.");
      }
      modalUserBackdrop.classList.add("hidden");
      modalUserBackdrop.classList.remove("flex");
      renderUserManagementTable(userSearchInput.value);
    });

    userCancelBtn.addEventListener("click", () => {
      modalUserBackdrop.classList.add("hidden");
      modalUserBackdrop.classList.remove("flex");
    });

    document.getElementById("btn-add-user").addEventListener("click", openUserModalForAdd);

    userSearchInput.addEventListener("input", () => {
      renderUserManagementTable(userSearchInput.value);
    });

    // Unit Management Functions
    let editingUnitId = null;

    function renderUnitManagementTable(filter = "") {
      unitManagementTbody.innerHTML = "";
      let filteredUnits = units;
      if (filter.trim() !== "") {
        const f = filter.toLowerCase();
        filteredUnits = units.filter(u => u.name.toLowerCase().includes(f));
      }
      if (filteredUnits.length === 0) {
        unitManagementTbody.innerHTML = `
          <tr>
            <td colspan="3" class="text-center py-6 text-gray-500 italic">Tidak ada unit ditemukan.</td>
          </tr>
        `;
        return;
      }
      filteredUnits.forEach((u, idx) => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td class="py-3 px-4 border-b border-gray-200">${idx + 1}</td>
          <td class="py-3 px-4 border-b border-gray-200">${u.name}</td>
          <td class="py-3 px-4 border-b border-gray-200 flex gap-2">
            <button data-id="${u.id}" class="btn-edit-unit px-2 py-1 bg-yellow-500 text-white rounded hover:bg-yellow-600 text-xs flex items-center gap-1"><i class="fas fa-edit"></i> Edit</button>
            <button data-id="${u.id}" class="btn-delete-unit px-2 py-1 bg-red-600 text-white rounded hover:bg-red-700 text-xs flex items-center gap-1"><i class="fas fa-trash-alt"></i> Hapus</button>
          </td>
        `;
        unitManagementTbody.appendChild(tr);
      });

      // Edit buttons
      unitManagementTbody.querySelectorAll(".btn-edit-unit").forEach(btn => {
        btn.addEventListener("click", (e) => {
          const id = e.currentTarget.getAttribute("data-id");
          openUnitModalForEdit(id);
        });
      });

      // Delete buttons
      unitManagementTbody.querySelectorAll(".btn-delete-unit").forEach(btn => {
        btn.addEventListener("click", (e) => {
          const id = e.currentTarget.getAttribute("data-id");
          // Check if any complaint uses this unit
          const usedInComplaints = complaints.some(c => {
            const unitObj = units.find(u => u.id === id);
            return unitObj && c.unit === unitObj.name;
          });
          if (usedInComplaints) {
            alert("Unit ini tidak dapat dihapus karena sedang digunakan dalam pengaduan.");
            return;
          }
          if (confirm("Apakah Anda yakin ingin menghapus unit ini?")) {
            units = units.filter(u => u.id !== id);
            saveUnits();
            renderUnitManagementTable(unitSearchInput.value);
            populateUnitSelect();
            alert("Unit berhasil dihapus.");
          }
        });
      });
    }

    function openUnitModalForAdd() {
      editingUnitId = null;
      modalUnitTitle.textContent = "Tambah Unit";
      unitForm.reset();
      modalUnitBackdrop.classList.remove("hidden");
      modalUnitBackdrop.classList.add("flex");
      unitForm.querySelector("#unit-name").focus();
    }

    function openUnitModalForEdit(id) {
      const unit = units.find(u => u.id === id);
      if (!unit) return;
      editingUnitId = id;
      modalUnitTitle.textContent = "Edit Unit";
      unitForm.reset();
      unitForm.querySelector("#unit-name").value = unit.name || "";
      modalUnitBackdrop.classList.remove("hidden");
      modalUnitBackdrop.classList.add("flex");
      unitForm.querySelector("#unit-name").focus();
    }

    unitForm.addEventListener("submit", (e) => {
      e.preventDefault();
      const name = unitForm.querySelector("#unit-name").value.trim();
      if (!name) {
        alert("Nama unit harus diisi.");
        return;
      }
      // Check for duplicate name (case insensitive)
      const nameExists = units.some(u => u.name.toLowerCase() === name.toLowerCase() && u.id !== editingUnitId);
      if (nameExists) {
        alert("Nama unit sudah ada.");
        return;
      }
      if (editingUnitId) {
        // Edit mode
        const unitIndex = units.findIndex(u => u.id === editingUnitId);
        if (unitIndex === -1) {
          alert("Unit tidak ditemukan.");
          return;
        }
        // Update complaints unit name if changed
        const oldName = units[unitIndex].name;
        if (oldName !== name) {
          complaints.forEach(c => {
            if (c.unit === oldName) {
              c.unit = name;
            }
          });
          saveComplaints();
        }
        units[unitIndex].name = name;
        saveUnits();
        alert("Unit berhasil diperbarui.");
      } else {
        // Add mode
        units.push({ id: crypto.randomUUID(), name });
        saveUnits();
        alert("Unit berhasil ditambahkan.");
      }
      modalUnitBackdrop.classList.add("hidden");
      modalUnitBackdrop.classList.remove("flex");
      renderUnitManagementTable(unitSearchInput.value);
      populateUnitSelect();
    });

    unitCancelBtn.addEventListener("click", () => {
      modalUnitBackdrop.classList.add("hidden");
      modalUnitBackdrop.classList.remove("flex");
    });

    document.getElementById("btn-add-unit").addEventListener("click", openUnitModalForAdd);

    unitSearchInput.addEventListener("input", () => {
      renderUnitManagementTable(unitSearchInput.value);
    });

    // Initialize view
    initialize();
  </script>
</body>
</html>